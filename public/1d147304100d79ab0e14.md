---
title: ã€Snowflakeã®Task/DAGã«ã¤ã„ã¦)ã€€Snowflake ã«ãŠã‘ã‚‹ Task / DAG ã® Python API ç®¡ç†ã®æ¦‚è¦ã«ã¤ã„ã¦
tags:
  - Python
  - ãƒ‡ãƒ¼ã‚¿åˆ†æåŸºç›¤
  - Snowflake
  - DAG
private: false
updated_at: '2025-06-09T15:09:38+09:00'
id: 1d147304100d79ab0e14
organization_url_name: null
slide: false
ignorePublish: false
---

## ç‰¹å¾´ï¼ˆFeature Statusï¼‰
æ©Ÿèƒ½ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šä¸€èˆ¬æä¾›ï¼ˆGAï¼‰
åˆ©ç”¨ä¸å¯ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼šæ”¿åºœã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆGovernment Regionsï¼‰

## æ¦‚è¦ï¼šSnowflake ã‚¿ã‚¹ã‚¯ã‚’ Python ã§ç®¡ç†ã™ã‚‹
Snowflake ã§ã¯ Python ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯å‡¦ç†ãŒå¯èƒ½ã§ã™ï¼š

SQL ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã®è‡ªå‹•å®Ÿè¡Œ

ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ï¼ˆSPï¼‰ã®å®Ÿè¡Œ

Snowflake Scripting ã«ã‚ˆã‚‹åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ

ã•ã‚‰ã«ã€è¤‡æ•°ã‚¿ã‚¹ã‚¯ã®ä¾å­˜é–¢ä¿‚ã‚’æŒã£ãŸã€Œã‚¿ã‚¹ã‚¯ã‚°ãƒ©ãƒ•ï¼ˆDAGï¼‰ã€ã‚‚å®šç¾©ã§ãã¾ã™

ğŸ§© Task ã¨ TaskResource ã®é•ã„
ã‚¯ãƒ©ã‚¹å	å½¹å‰²
Task	ã‚¿ã‚¹ã‚¯ã®å®šç¾©æƒ…å ±ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»ä¸­èº«ãƒ»ä¾å­˜ãªã©ï¼‰
TaskResource	æ—¢å­˜ã‚¿ã‚¹ã‚¯ã«å¯¾ã™ã‚‹æ“ä½œï¼ˆå®Ÿè¡Œãƒ»ä¸€æ™‚åœæ­¢ãƒ»å‰Šé™¤ãªã©ï¼‰

## ğŸ”Œ æ¥ç¶šã¨åˆæœŸåŒ–
```python
from snowflake.core import Root
from snowflake.snowpark import Session

session = Session.builder.config("connection_name", "myconnection").create()
root = Root(session)
```
Root ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã£ã¦ã€Snowflake ã® Python API ç¾¤ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚


## ğŸ—ï¸ Task ã‚’ä½œæˆã™ã‚‹
ä¸‹è¨˜ã§SQLå®Ÿè¡Œã‚¿ã‚¹ã‚¯ã®ä½œæˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚
Task()ã§Snowflake ã«ç™»éŒ²ã™ã‚‹ã‚¿ã‚¹ã‚¯ã®æƒ…å ±ã‚’ Python ã‚³ãƒ¼ãƒ‰ä¸Šã§è¡¨ç¾ã™ã‚‹ãŸã‚ã®å®šç¾©ã‚’å®Ÿæ–½ã—ã¦ã„ã‚‹ã€‚

```python
from datetime import timedelta
from snowflake.core.task import Task

my_task = Task(name="my_task", definition="SELECT 1;", schedule=timedelta(hours=1))
tasks = root.databases['my_db'].schemas['my_schema'].tasks
tasks.create(my_task)
```
definition: å®Ÿè¡Œã™ã‚‹ SQLï¼ˆã¾ãŸã¯å¾Œè¿°ã® SP å‘¼ã³å‡ºã—ï¼‰
schedule: timedelta ã‚‚ã—ãã¯ Cron ã§è¨­å®šå¯èƒ½

StoredProcedure ã‚’å‘¼ã³å‡ºã™ã‚¿ã‚¹ã‚¯ã®ä½œæˆ
```python
from snowflake.core.task import StoredProcedureCall

my_task2 = Task(
    "my_task2",
    StoredProcedureCall(dosomething, stage_location="@mystage"),
    warehouse="test_warehouse"
)
tasks.create(my_task2)
```
â€» warehouse ã®æŒ‡å®šãŒå¿…é ˆã§ã™ã€‚

## ğŸ” ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ï¼ˆcreate_or_alterï¼‰

my_task = tasks["my_task"].fetch()
my_task.definition = "SELECT 2;"
my_task.schedule = timedelta(hours=2)
tasks["my_task"].create_or_alter(my_task)


## ğŸ“ƒ ã‚¿ã‚¹ã‚¯ä¸€è¦§å–å¾—
task_iter = tasks.iter(like="my%")
for task in task_iter:
    print(task.name)

â–¶ï¸ ã‚¿ã‚¹ã‚¯æ“ä½œï¼šå®Ÿè¡Œãƒ»ä¸€æ™‚åœæ­¢ãƒ»å†é–‹ãƒ»å‰Šé™¤
task_res = tasks['my_task']
task_res.execute()
task_res.suspend()
task_res.resume()
task_res.drop()

## ğŸ§  DAGï¼ˆã‚¿ã‚¹ã‚¯ã‚°ãƒ©ãƒ•ï¼‰ã‚’æ§‹ç¯‰ã™ã‚‹
DAG æ§‹é€ ã®å®šç¾©ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸‹è¨˜ã§å®Ÿè¡Œã§ãã‚‹ã€‚
DAGã§DAGã®åå‰ã®å®šç¾©ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®šç¾©ã™ã‚‹ã€‚ãã®å¾Œã«DAGTask()ã«ãŠã„ã¦å„Taskã®å®šç¾©ã‚’è¡Œã„ã€ä¾å­˜é–¢ä¿‚ã‚‚å®šç¾©ã™ã‚‹(`dag_task1 >> dag_task2`)ã€‚
```python
from snowflake.core.task.dagv1 import DAG, DAGTask, DAGOperation
from snowflake.core.task import StoredProcedureCall

with DAG("my_dag", schedule=timedelta(days=1)) as dag:
    dag_task1 = DAGTask("dagtask1", "MERGE INTO ...")
    dag_task2 = DAGTask(
        StoredProcedureCall(dosomething, stage_location="@mystage", packages=["snowflake-snowpark-python"]),
        warehouse="test_warehouse"
    )
dag_task1 >> dag_task2  # ä¾å­˜é–¢ä¿‚ï¼ˆtask1 â†’ task2ï¼‰

schema = root.databases["my_db"].schemas["my_schema"]
dag_op = DAGOperation(schema)
dag_op.deploy(dag)
```

## â° Cron ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« + ãƒ–ãƒ©ãƒ³ãƒä»˜ã DAG + æˆ»ã‚Šå€¤åˆ©ç”¨
ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãŸ
```python
from snowflake.core.task.dagv1 import DAGTaskBranch

def task_branch_handler(session) -> str:
    return "task3"

with DAG(
    "my_dag",
    schedule=Cron("10 * * * *", "America/Los_Angeles"),
    stage_location="@mystage",
    use_func_return_value=True
) as dag:
    task1 = DAGTask("task1", task_handler, warehouse=test_warehouse)
    task1_branch = DAGTaskBranch("task1_branch", task_branch_handler, warehouse=test_warehouse)
    task2 = DAGTask("task2", task_handler, warehouse=test_warehouse)
    task3 = DAGTask("task3", task_handler, warehouse=test_warehouse, condition="1=1")

    task1 >> task1_branch
    task1_branch >> [task2, task3]
```
## å‰å¾Œã‚¿ã‚¹ã‚¯é–“ã§å€¤ã‚’å—ã‘æ¸¡ã™ï¼ˆTaskContextï¼‰

```python
from snowflake.core.task.context import TaskContext

def producer(session):
    ctx = TaskContext(session)
    ctx.set_return_value("result_123")

def consumer(session):
    ctx = TaskContext(session)
    value = ctx.get_predecessor_return_value("producer")
```
